@model WebApplication1_Test1.Models.LockerReservationModel

@{
    ViewData["Title"] = "Request Locker Reservation";
}

<div class="container mt-4">
    <div class="row">
        <div class="col-md-8 offset-md-2">
            <div class="card">
                <div class="card-header bg-success text-white">
                    <h3 class="mb-0">🔐 Request Locker Reservation</h3>
                </div>
                <div class="card-body">
                    <!-- User Info Status Alert -->
                    <div id="userInfoAlert" class="alert alert-info d-none">
                        <i class="fas fa-info-circle"></i>
                        <span id="userInfoMessage">Loading your information...</span>
                    </div>

                    <!-- Error messages -->
                    <div id="errorSummary" asp-validation-summary="All" class="alert alert-danger d-none"></div>

                    @if (TempData["ErrorMessage"] != null)
                    {
                        <div class="alert alert-danger">
                            @TempData["ErrorMessage"]
                        </div>
                    }

                    <form id="reservationForm" asp-action="Create" asp-controller="LockerReservations" method="post" onsubmit="return validateAndSubmitForm()">
                        @Html.AntiForgeryToken()

                        <!-- Personal Information -->
                        <h5 class="mb-3">Personal Information</h5>

                        <!-- User ID Field (Visible) -->
                        <div class="row mb-3">
                            <div class="col-md-6" hidden>
                                <label asp-for="UserId"></label>
                                <input asp-for="UserId" class="form-control" id="UserId" required value="123"
                                       placeholder="Enter your user ID" />
                                <span asp-validation-for="UserId" class="text-danger"></span>
                                <small class="form-text text-muted">Enter your unique user ID (e.g., student ID or employee number)</small>
                            </div>
                            <div class="col-md-6">
                                <label asp-for="UserEmail"></label>
                                <input asp-for="UserEmail" type="email" class="form-control" id="UserEmail"
                                       placeholder="example@email.com" required />
                                <span asp-validation-for="UserEmail" class="text-danger"></span>
                                <small class="form-text text-muted">Your registered email address</small>
                            </div>
                        </div>

                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label asp-for="LastName"></label>
                                <input asp-for="LastName" class="form-control" id="LastName" required />
                                <span asp-validation-for="LastName" class="text-danger"></span>
                            </div>
                            <div class="col-md-6">
                                <label asp-for="FirstName"></label>
                                <input asp-for="FirstName" class="form-control" id="FirstName" required />
                                <span asp-validation-for="FirstName" class="text-danger"></span>
                            </div>
                        </div>

                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label asp-for="ContactNumber"></label>
                                <input asp-for="ContactNumber" class="form-control" id="ContactNumber"
                                       placeholder="09XXXXXXXXX or +639XXXXXXXXX" required
                                       pattern="^(09|\+639)\d{9}$"
                                       title="Please enter a valid Philippine phone number (09XXXXXXXXX or +639XXXXXXXXX)" />
                                <span asp-validation-for="ContactNumber" class="text-danger"></span>
                                <small class="form-text text-muted">Format: 09XXXXXXXXX or +639XXXXXXXXX</small>
                            </div>
                            <div class="col-md-6">
                                <label asp-for="Semester"></label>
                                <select asp-for="Semester" class="form-select" id="Semester" required>
                                    <option value="">-- Select Semester --</option>
                                    <option value="First Semester">First Semester</option>
                                    <option value="Second Semester">Second Semester</option>
                                    <option value="Summer">Summer</option>
                                </select>
                                <span asp-validation-for="Semester" class="text-danger"></span>
                            </div>
                        </div>

                        <!-- Locker Information -->
                        <h5 class="mb-3 mt-4">Locker Information</h5>
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label asp-for="LockerNumber"></label>
                                <select asp-for="LockerNumber" class="form-select" required>
                                    <option value="">-- Select Locker --</option>
                                    @for (int i = 1; i <= 10; i++)
                                    {
                                        <option value="Locker @i">Locker @i</option>
                                    }
                                </select>
                                <span asp-validation-for="LockerNumber" class="text-danger"></span>
                            </div>
                            <div class="col-md-6">
                                <label asp-for="Purpose"></label>
                                <input asp-for="Purpose" class="form-control" placeholder="e.g., Storage of academic materials" required />
                                <span asp-validation-for="Purpose" class="text-danger"></span>
                                <small class="form-text text-muted">Brief description of what you'll store</small>
                            </div>
                        </div>

                        <!-- Dates -->
                        <h5 class="mb-3 mt-4">Reservation Period</h5>
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label asp-for="StartDate"></label>
                                <input asp-for="StartDate" type="date" class="form-control" required min="@DateTime.Today.ToString("yyyy-MM-dd")" />
                                <span asp-validation-for="StartDate" class="text-danger"></span>
                                <small class="form-text text-muted">Cannot be earlier than today</small>
                            </div>
                            <div class="col-md-6">
                                <label asp-for="EndDate"></label>
                                <input asp-for="EndDate" type="date" class="form-control" required min="@DateTime.Today.ToString("yyyy-MM-dd")" />
                                <span asp-validation-for="EndDate" class="text-danger"></span>
                                <small class="form-text text-muted">Cannot be earlier than start date</small>
                            </div>
                        </div>

                        <!-- Hidden fields -->
                        <input type="hidden" asp-for="Status" value="Pending" />
                        <input type="hidden" asp-for="RequestDate" value="@DateTime.Now.ToString("yyyy-MM-ddTHH:mm:ss")" />

                        <div class="d-flex justify-content-between mt-4">
                            <a asp-action="Index" class="btn btn-secondary">Cancel</a>
                            <button type="submit" class="btn btn-success" id="submitBtn">
                                <i class="fas fa-paper-plane"></i> Submit Request
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Set default dates
            const today = new Date().toISOString().split('T')[0];
            const oneYearLater = new Date();
            oneYearLater.setFullYear(oneYearLater.getFullYear() + 1);
            const oneYearLaterStr = oneYearLater.toISOString().split('T')[0];

            const startDateInput = document.getElementById('StartDate');
            const endDateInput = document.getElementById('EndDate');

            if (startDateInput && !startDateInput.value) {
                startDateInput.value = today;
                startDateInput.min = today;
            }
            if (endDateInput && !endDateInput.value) {
                endDateInput.value = oneYearLaterStr;
                endDateInput.min = today;
            }

            // Update min date for end date when start date changes
            if (startDateInput) {
                startDateInput.addEventListener('change', function() {
                    if (endDateInput && this.value) {
                        endDateInput.min = this.value;
                        if (endDateInput.value && new Date(endDateInput.value) < new Date(this.value)) {
                            endDateInput.value = this.value;
                        }
                    }
                });
            }

            // Try to auto-populate UserId from logged-in user (if available)
            tryAutoPopulateUserId();

            // Real-time validation for contact number
            const contactInput = document.getElementById('ContactNumber');
            if (contactInput) {
                contactInput.addEventListener('input', function() {
                    this.value = this.value.replace(/[^0-9+]/g, '');
                });
            }
        });

        async function tryAutoPopulateUserId() {
            try {
                // Try to get current user info
                const response = await fetch('/UserInfo/GetCurrentUserInfo');
                const data = await response.json();

                if (data.success && data.userInfo) {
                    const userInfo = data.userInfo;
                    const userIdInput = document.getElementById('UserId');

                    // If UserId field is empty, populate it
                    if (userIdInput && !userIdInput.value.trim()) {
                        userIdInput.value = userInfo.UserId || '';
                    }

                    // Also populate other fields if empty
                    populateIfEmpty('FirstName', userInfo.FirstName);
                    populateIfEmpty('LastName', userInfo.LastName);
                    populateIfEmpty('ContactNumber', userInfo.ContactNumber);
                    populateIfEmpty('UserEmail', userInfo.Email);
                    populateIfEmpty('Semester', userInfo.Semester);
                }
            } catch (error) {
                console.log('Could not auto-populate user info:', error);
                // Silent fail - user will enter manually
            }
        }

        function populateIfEmpty(fieldId, value) {
            if (!value) return;

            const field = document.getElementById(fieldId);
            if (field && !field.value.trim()) {
                field.value = value;
            }
        }

        function validateAndSubmitForm() {
            const form = document.getElementById('reservationForm');
            const errorSummary = document.getElementById('errorSummary');
            const submitBtn = document.getElementById('submitBtn');

            // Hide error summary initially
            if (errorSummary) {
                errorSummary.classList.add('d-none');
            }

            // Clear previous error messages
            const errorSpans = form.querySelectorAll('.text-danger');
            errorSpans.forEach(span => span.textContent = '');

            let isValid = true;
            const errors = [];

            // Validate that UserId is set
            const userId = document.getElementById('UserId').value;
            if (!userId || !userId.trim()) {
                errors.push('User ID is required. Please enter your unique user ID.');
                isValid = false;
            }

            // Validate Contact Number
            const contact = document.getElementById('ContactNumber');
            if (contact && contact.value) {
                const phoneRegex = /^(09|\+639)\d{9}$/;
                if (!phoneRegex.test(contact.value)) {
                    errors.push('Contact number must be in format: 09XXXXXXXXX or +639XXXXXXXXX');
                    const span = contact.nextElementSibling;
                    if (span && span.classList.contains('text-danger')) {
                        span.textContent = 'Format: 09XXXXXXXXX or +639XXXXXXXXX';
                    }
                    isValid = false;
                }
            }

            // Validate Dates
            const startDate = document.getElementById('StartDate');
            const endDate = document.getElementById('EndDate');
            if (startDate && endDate && startDate.value && endDate.value) {
                const start = new Date(startDate.value);
                const end = new Date(endDate.value);
                const today = new Date();
                today.setHours(0, 0, 0, 0);

                if (start < today) {
                    errors.push('Start date cannot be in the past');
                    isValid = false;
                }

                if (end < start) {
                    errors.push('End date cannot be earlier than start date');
                    isValid = false;
                }
            }

            // Validate Required Fields
            const requiredFields = form.querySelectorAll('[required]');
            requiredFields.forEach(field => {
                if (!field.value.trim()) {
                    const fieldName = field.labels?.[0]?.textContent || field.name;
                    errors.push(`${fieldName} is required`);
                    isValid = false;
                }
            });

            // Show errors if any
            if (errors.length > 0 && errorSummary) {
                errorSummary.innerHTML = '';
                errors.forEach(error => {
                    const li = document.createElement('li');
                    li.textContent = error;
                    errorSummary.appendChild(li);
                });
                errorSummary.classList.remove('d-none');
                errorSummary.scrollIntoView({ behavior: 'smooth', block: 'center' });

                return false;
            }

            // Disable submit button to prevent double submission
            if (submitBtn) {
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Submitting...';
            }

            return isValid;
        }

        // Auto-format phone number as user types
        document.addEventListener('input', function(e) {
            if (e.target.id === 'ContactNumber') {
                let value = e.target.value.replace(/[^0-9+]/g, '');

                // Auto-format for Philippine numbers
                if (value.startsWith('09') && value.length === 11) {
                    // Already in correct format: 09XXXXXXXXX
                } else if (value.startsWith('639') && value.length === 12) {
                    // Convert 639XXXXXXXXX to +639XXXXXXXXX
                    value = '+' + value;
                } else if (value.startsWith('9') && value.length === 10) {
                    // Convert 9XXXXXXXXX to 09XXXXXXXXX
                    value = '0' + value;
                }

                e.target.value = value;
            }
        });
    </script>
}